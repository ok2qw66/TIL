참고 : https://docs.amazonaws.cn/en_us/vpc/latest/userguide/VPC_Subnets.html#vpc-subnet-basics

![region_vpc_az_subnet_ec2](https://user-images.githubusercontent.com/69428620/95179158-3d34fa80-07fb-11eb-9b0e-87177fd9d60d.png)

### VPC(Virtual Private Cloud)

- 네트워크 계층

- EC2 인스턴스를 비롯한 여러 AWS 서비스의 리소스를 담을 수 있는 가상 네트워크

- 한 AWS 리전 안에서만 존재할 수 있고, 한 리전에 만든 VPC는 다른 리전에서는 보이지 않음

  => 자연재해 등으로 서비스가 중단되는 것을 막기위해서 리전안에 존재하게 함

- 연속적인 IP 주소 범위로 구성 => CIDR 블록으로 표시

  - 10.0.0.0/8 => 10.0.0.0 ~ 10.255.255.255
  - 172.16.0.0./12 => 172.16.0.0 ~ 172.31.255.255
  - 192.168.0.0/16 => 192.168.0.0  ~ 192.168.255.255

> 10.0.0.0/8 에서 8의 의미
>
> 10까지는 network IP로 고정 그 이후 부분은 host IP로 0~255까지 사용가능

> 172.16.0.0./12에서 12의 의미
>
> 12 = 8+4 이므로 172까지는 network IP로 고정 & 4는 8의 절반이므로 16~31까지 사용가능
>
> 그 이후 부분은 0~255 사용가능

> 192.168.0.0/16에서 16의 의미
>
> 16 = 8+8 이므로 192.168 까지 network IP로 고정, 그 이후부분은 0~255까지 사용가능



>172.16.0.0/16 		⇒ 172.16.0.0 ~ 172.16.255.255
>
>1111 1111 1111 1111 0000 0000 0000 0000

>172.16.1.0/24
>
>172.16.1.0~172.16.1.255



### 서브넷(subnet)

- VPC 내 논리 컨테이너

- EC2 인스턴스를 배치하는 장소 = 인스턴스는 서브넷 안에 위치

  - 한번 서브넷에 인스턴스를 생성하면 다른 서브넷으로 옮길 수 없음
  - 인스턴스를 종료하고 다른 서브넷에 새 인스턴스를 만들어야 한다

- 인스턴스를 서로 격리하고, 인스턴스 간의 트래픽 흐름을 제어하고, 인스턴스를 기능별로 묶을 수 있다

- 서브넷 CIDR 블록

  - VPC의 일부, VPC 내에서는 unique해야 한다

  - 모든 서브넷에서 처음 4개의 IP와 마지막 1개는 예약되어 있으므로 인스턴스에 할당할 수 없음

    EX: 서브넷 CIDR이 172.168.100.0/24인 경우

    ​       172.16.100.0 ~ 172.16.100.3

    ​       172.16.100.255 

- 서브넷은 하나의 가용영역(Available Zone, AZ) 내에서만 존재가능



### ENI(Elastic Network Interface : 탄력적 네트워크 인터페이스)

- 물리 서버의 네트워크 인터페이스와 같은 기능을 수행



### 인터넷 게이트웨이(igw)

- 퍼블릭 IP 주소를 할당받은 인스턴스가 인터넷과 연결돼서 요청을 수신할 수 있도록 기능을 제공
- 처음 VPC를 만들면 인터넷 게이트웨이가 연결되어 있지 않으므로, 직접 인터넷 게이트웨이를 만들고 VPC와 연결해야 한다
- 하나의 VPC는 하나의 인터넷 게이트에이만 연결할 수 있음



### 라우팅

- vpc는 소프트웨어 함수로 IP 라우팅을 구현 => 사용자는 라우팅 테이블만 관리하면 된다

- 라우팅 테이블 -> 하나 이상의 라우팅과 하나 이상의 서브넷 연결로 구성

- 기본 라우팅 : 인터넷 게이트웨이를 가리키는 말

  | 대상주소                        | 대상              |
  | ------------------------------- | ----------------- |
  | 0.0.0.0/0                       | igw-xxxxxxxxx     |
  | 인터넷 상의 모든 host IP를 기반 | 인터넷 게이트웨이 |

- 기본 라우팅이 포함된 라우팅 테이블과 연결된 서브넷 == igw와 연결 ==  퍼블릭 서브넷

- 기본 라우팅이 포함된 라우팅 테이블과 연결되지 않은 서브넷 == igw와 연결x == 프라이빗 서브넷

  |                                            | public subnet | private subnet |
  | ------------------------------------------ | ------------- | -------------- |
  | 기본 라우팅 포함된 라우팅테이블과 연결여부 | O             | X              |

  - 라우팅할 위치와 가장 근접하게 일치하는 항목을 기반으로 라우팅 처리
  - 라우팅 테이블의 항목 **순서는 중요하지 않음**

  | 대상주소      | 대상          |
  | ------------- | ------------- |
  | 172.31.0.0/16 | LOCAL         |
  | 0.0.0.0/0     | igw-xxxxxxxxx |

  198.51.100.50 으로 패킷을 보내려고 한다

  => 인터넷 게이트웨이로 라우팅됨(LOCAL은 처음부터 일치x)

![image-20201006114224531](https://user-images.githubusercontent.com/69428620/95178714-b7b14a80-07fa-11eb-9f2a-4f9d9569bb1f.png)

### 보안 그룹

- 방화벽과 같은 기능을 제공

- 인스턴스의 ENI에서 송수신하는 트래픽을 허가해서 트래픽을 제어

- 모든 ENI는 최소 한개 이상의  보안 그룹과 연결되어야 함

  보안그룹은 여러 개의 ENI와 연결될 수 있음 (N:N 관계)

- 생성할 때 보안 그룹 이름, 설명, 포함될 VPC를 지정하고

  생성 후에 인바운드, 아웃바운드 규칙을 지정 => 트래픽을 허용 (default : 막혀있음)

- 화이트리스트 방식을 적용한다

- >  접근 제어

  - 블랙리스트 방식 :  접근 제한할 것들만 정의

    80포트는 안쓴다 => 80포트로 들어오면 못들어오게 막는다

  - 화이트리스트 방식 : 허가하는 것만 정의

    22번 포트는 허가한다 => 22번포트로 들어오지 않으면 다 막아버린다

  > 인바운드 규칙 : 들어올 때 적용하는 규칙
  >
  > 아웃바운드 규칙: 나갈 때 적용하는 규칙

- 상태 저장 방화벽 역할 => 보안 그룹이 트래픽을 한 방향으로 전달되도록 허용할 때 반대 방향의 응답 트래픽을 지능적으로 허용

  (예: 웹 클라이언트에서 HTTPS로 요청을 허용했다면 요청에 대한 응답도 허용)



### NACL(Network Access Control List)

- 보안 그룹과 유사
  - 원본 또는 대상 주소 범위 CIDR, 프로토콜, 포트를 기반으로 트래픽을 인바운드, 아웃바운드 규칙으로 제어  => 방화벽과 같은 역할
  - VPC에 삭제할 수없는 기본 NACL이 있음
  
- 서브넷에 연결되어 해당 서브넷과 송수신되는 트래픽을 제어

- 상태 비저장
  - NACL을 통과한 연결 상태를 추적하지 않는다
  - 모든 인바운드와 아웃바운드 트래픽의 허용 규칙을 별도로 작성해야함
  
- 규칙을 적용할 때 규칙 번호의 오름차순으로 처리

  => 마지막에 적용되는 것이 * 이다

![image-20201006110424395](https://user-images.githubusercontent.com/69428620/95179648-e2e86980-07fb-11eb-9743-36dc4fbdc680.png)

  - 1. 80포트인지 확인
    2. 22포트인지 확인
    3. 아니면 DENY

